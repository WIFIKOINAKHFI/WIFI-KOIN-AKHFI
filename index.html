<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIFI KOIN AKHFI - Sistem Manajemen</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            color: #333;
            padding-top: 20px;
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: var(--primary);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-paid {
            background-color: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
        }
        
        .status-invoiced {
            background-color: rgba(67, 97, 238, 0.2);
            color: #4361ee;
        }
        
        .status-pending {
            background-color: rgba(247, 37, 133, 0.2);
            color: #f72585;
        }
        
        .status-cancelled {
            background-color: rgba(108, 117, 125, 0.2);
            color: #6c757d;
        }
        
        .btn-action {
            border-radius: 8px;
            font-weight: 600;
            padding: 8px 16px;
            margin: 5px;
        }
        
        .btn-paid {
            background-color: #4cc9f0;
            border-color: #4cc9f0;
            color: white;
        }
        
        .btn-invoiced {
            background-color: #4361ee;
            border-color: #4361ee;
            color: white;
        }
        
        .btn-pending {
            background-color: #f72585;
            border-color: #f72585;
            color: white;
        }
        
        .btn-cancelled {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .client-item {
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .client-item:hover {
            background-color: rgba(67, 97, 238, 0.05);
            border-left-color: var(--primary);
        }
        
        .client-item.selected {
            background-color: rgba(67, 97, 238, 0.1);
            border-left-color: var(--primary);
        }
        
        .stat-card {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            color: white;
        }
        
        .stat-card.total {
            background: linear-gradient(135deg, #4361ee, #3a56d4);
        }
        
        .stat-card.paid {
            background: linear-gradient(135deg, #4cc9f0, #3ab5d9);
        }
        
        .stat-card.invoiced {
            background: linear-gradient(135deg, #7209b7, #5f0b9c);
        }
        
        .stat-card.pending {
            background: linear-gradient(135deg, #f72585, #d91a6d);
        }
        
        .stat-card.cancelled {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: #333;
        }
        
        .form-check-input:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-reset {
            background-color: #f72585;
            border-color: #f72585;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .nav-tabs .nav-link {
            color: var(--primary);
        }
        
        .portal-item {
            border-left: 4px solid #7209b7;
        }
        
        .portal-profit {
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .portal-partner {
            font-weight: bold;
            color: #f72585;
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-action {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center mb-0">WIFI KOIN AKHFI</h1>
                <p class="text-center text-muted">Sistem Manajemen Penagihan & Portal</p>
            </div>
        </div>

        <!-- Tab Navigasi -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="client-tab" data-bs-toggle="tab" data-bs-target="#client" type="button" role="tab" aria-controls="client" aria-selected="true">
                    <i class="fas fa-users"></i> Klien & Penagihan
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="portal-tab" data-bs-toggle="tab" data-bs-target="#portal" type="button" role="tab" aria-controls="portal" aria-selected="false">
                    <i class="fas fa-cube"></i> Portal
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab" aria-controls="backup" aria-selected="false">
                    <i class="fas fa-download"></i> Backup & Restore
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="myTabContent">
            <!-- Tab Klien -->
            <div class="tab-pane fade show active" id="client" role="tabpanel" aria-labelledby="client-tab">
                <div class="row">
                    <!-- Panel Klien -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Daftar Klien</span>
                                <div>
                                    <span class="badge bg-light text-dark" id="client-count">0 klien</span>
                                    <button class="btn btn-sm btn-light ms-2" id="add-client-btn" data-bs-toggle="modal" data-bs-target="#addClientModal">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush" id="client-list">
                                    <!-- Daftar klien akan diisi oleh JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                Aksi Penagihan
                            </div>
                            <div class="card-body">
                                <div class="action-buttons" id="action-buttons">
                                    <button class="btn btn-paid btn-action" id="btn-paid">
                                        <i class="fas fa-money-bill-wave"></i> Sudah Bayar
                                    </button>
                                    <button class="btn btn-invoiced btn-action" id="btn-invoiced">
                                        <i class="fas fa-receipt"></i> Sudah Ditagih
                                    </button>
                                    <button class="btn btn-pending btn-action" id="btn-pending">
                                        <i class="fas fa-clock"></i> Belum Ditagih
                                    </button>
                                    <button class="btn btn-cancelled btn-action" id="btn-cancelled">
                                        <i class="fas fa-ban"></i> Dibatalkan
                                    </button>
                                </div>
                                <div class="mt-3 text-center">
                                    <small class="text-muted">Pilih klien terlebih dahulu sebelum mengubah status</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Panel Laporan dan Statistik -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                Laporan & Rekapan Penagihan
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h5>Jenis Laporan:</h5>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="report-all">
                                            <label class="form-check-label" for="report-all">
                                                Semua Data
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="report-paid" checked>
                                            <label class="form-check-label" for="report-paid">
                                                Sudah Bayar
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="report-invoiced" checked>
                                            <label class="form-check-label" for="report-invoiced">
                                                Sudah Ditagih
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="report-pending" checked>
                                            <label class="form-check-label" for="report-pending">
                                                Belum Ditagih
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="report-cancelled" checked>
                                            <label class="form-check-label" for="report-cancelled">
                                                Dibatalkan
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Aksi Laporan:</h5>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="action-telegram">
                                            <label class="form-check-label" for="action-telegram">
                                                Kirim Laporan Bayar ke Telegram
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="action-download-paid" checked>
                                            <label class="form-check-label" for="action-download-paid">
                                                Download Laporan Bayar (Excel)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="action-download-all" checked>
                                            <label class="form-check-label" for="action-download-all">
                                                Download Semua Laporan (Excel)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button class="btn btn-primary" id="generate-report">
                                        <i class="fas fa-file-export"></i> Generate Laporan
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                Statistik Cepat
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 col-md-3 mb-3">
                                        <div class="stat-card total">
                                            <div class="stat-number" id="stat-total">0</div>
                                            <div>Total Klien</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3 mb-3">
                                        <div class="stat-card paid">
                                            <div class="stat-number" id="stat-paid">0</div>
                                            <div>Sudah Bayar</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3 mb-3">
                                        <div class="stat-card invoiced">
                                            <div class="stat-number" id="stat-invoiced">0</div>
                                            <div>Sudah Ditagih</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3 mb-3">
                                        <div class="stat-card pending">
                                            <div class="stat-number" id="stat-pending">0</div>
                                            <div>Belum Ditagih</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                Reset Data Penagihan
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Hapus semua history penagihan (hati-hati!)</p>
                                <div class="d-grid">
                                    <button class="btn btn-reset" id="reset-data">
                                        <i class="fas fa-trash-alt"></i> Reset Data Penagihan
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Portal -->
            <div class="tab-pane fade" id="portal" role="tabpanel" aria-labelledby="portal-tab">
                <div class="row">
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Daftar Portal</span>
                                <button class="btn btn-sm btn-light" id="add-portal-btn" data-bs-toggle="modal" data-bs-target="#addPortalModal">
                                    <i class="fas fa-plus"></i> Tambah Portal
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush" id="portal-list">
                                    <!-- Daftar portal akan diisi oleh JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                Statistik Portal
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 mb-3">
                                        <div class="stat-card total">
                                            <div class="stat-number" id="portal-total">0</div>
                                            <div>Total Portal</div>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="stat-card paid">
                                            <div class="stat-number" id="portal-income">Rp 0</div>
                                            <div>Pendapatan Bersih</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <p><strong>Keterangan:</strong></p>
                                    <p>Setiap portal memberikan 20% dari total isi kepada partner.</p>
                                    <p>Pendapatan bersih = Total isi portal - 20% untuk partner</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header">
                                Laporan Portal
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <h5>Opsi Laporan:</h5>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="portal-report-all" checked>
                                        <label class="form-check-label" for="portal-report-all">
                                            Semua Portal
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="portal-report-excel" checked>
                                        <label class="form-check-label" for="portal-report-excel">
                                            Download Laporan Excel
                                        </label>
                                    </div>
                                </div>
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button class="btn btn-primary" id="generate-portal-report">
                                        <i class="fas fa-file-export"></i> Generate Laporan Portal
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                Detail Perhitungan
                            </div>
                            <div class="card-body">
                                <div id="portal-details">
                                    <!-- Detail portal akan diisi oleh JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Backup & Restore -->
            <div class="tab-pane fade" id="backup" role="tabpanel" aria-labelledby="backup-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-download"></i> Backup Data
                            </div>
                            <div class="card-body">
                                <p>Unduh data Anda untuk disimpan atau dipindahkan ke perangkat lain.</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" id="backup-clients">
                                        <i class="fas fa-users"></i> Backup Data Klien
                                    </button>
                                    <button class="btn btn-primary" id="backup-portals">
                                        <i class="fas fa-cube"></i> Backup Data Portal
                                    </button>
                                    <button class="btn btn-info" id="backup-all">
                                        <i class="fas fa-database"></i> Backup Semua Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-upload"></i> Restore Data
                            </div>
                            <div class="card-body">
                                <p>Unggah data dari file backup untuk mengembalikan data Anda.</p>
                                <div class="mb-3">
                                    <label for="restore-file" class="form-label">Pilih file backup:</label>
                                    <input class="form-control" type="file" id="restore-file" accept=".json">
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-warning" id="restore-data">
                                        <i class="fas fa-upload"></i> Restore Data
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <div class="alert alert-warning" role="alert">
                                        <i class="fas fa-exclamation-triangle"></i> 
                                        <strong>Peringatan:</strong> Restore data akan menggantikan semua data yang ada saat ini.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Klien -->
    <div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addClientModalLabel">Tambah Klien Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-client-form">
                        <div class="mb-3">
                            <label for="client-name" class="form-label">Nama Klien</label>
                            <input type="text" class="form-control" id="client-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="client-product" class="form-label">Produk</label>
                            <select class="form-select" id="client-product" required>
                                <option value="Paket Standar">Paket Standar</option>
                                <option value="Paket Premium">Paket Premium</option>
                                <option value="Paket Bisnis">Paket Bisnis</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="client-amount" class="form-label">Jumlah Tagihan (Rp)</label>
                            <input type="number" class="form-control" id="client-amount" required min="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-client">Simpan Klien</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Portal -->
    <div class="modal fade" id="addPortalModal" tabindex="-1" aria-labelledby="addPortalModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPortalModalLabel">Tambah Portal Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-portal-form">
                        <div class="mb-3">
                            <label for="portal-name" class="form-label">Nama Portal</label>
                            <input type="text" class="form-control" id="portal-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="portal-location" class="form-label">Lokasi</label>
                            <input type="text" class="form-control" id="portal-location" required>
                        </div>
                        <div class="mb-3">
                            <label for="portal-amount" class="form-label">Isi Portal (Rp)</label>
                            <input type="number" class="form-control" id="portal-amount" required min="0">
                        </div>
                        <div class="mb-3">
                            <label for="portal-partner" class="form-label">Nama Partner</label>
                            <input type="text" class="form-control" id="portal-partner" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-portal">Simpan Portal</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Data klien dan portal
        let clients = JSON.parse(localStorage.getItem('wifiKoinClients')) || [
            { id: 1, name: "PT. Maju Jaya", product: "Paket Bisnis", status: "pending", amount: 500000 },
            { id: 2, name: "CV. Sejahtera", product: "Paket Premium", status: "invoiced", amount: 350000 },
            { id: 3, name: "Toko Sinar Abadi", product: "Paket Standar", status: "paid", amount: 250000 },
            { id: 4, name: "UD. Makmur Sentosa", product: "Paket Premium", status: "pending", amount: 350000 }
        ];

        let portals = JSON.parse(localStorage.getItem('wifiKoinPortals')) || [
            { id: 1, name: "Portal A", location: "Mall Central", amount: 300000, partner: "Budi Santoso" },
            { id: 2, name: "Portal B", location: "Stasiun Kota", amount: 450000, partner: "Sari Indah" },
            { id: 3, name: "Portal C", location: "Kampus Merdeka", amount: 280000, partner: "Ahmad Fauzi" }
        ];

        let selectedClientId = null;
        let selectedPortalId = null;

        // Fungsi untuk menyimpan data ke localStorage
        function saveData() {
            localStorage.setItem('wifiKoinClients', JSON.stringify(clients));
            localStorage.setItem('wifiKoinPortals', JSON.stringify(portals));
        }

        // Fungsi untuk merender daftar klien
        function renderClientList() {
            const clientList = document.getElementById('client-list');
            clientList.innerHTML = '';
            
            if (clients.length === 0) {
                clientList.innerHTML = '<div class="list-group-item text-center text-muted">Tidak ada klien</div>';
            } else {
                clients.forEach(client => {
                    const statusClass = `status-${client.status}`;
                    const statusText = getStatusText(client.status);
                    
                    const clientItem = document.createElement('div');
                    clientItem.className = `list-group-item client-item ${selectedClientId === client.id ? 'selected' : ''}`;
                    clientItem.setAttribute('data-client-id', client.id);
                    
                    clientItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${client.name}</h5>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <p class="mb-1">${client.product}</p>
                        <small class="text-muted">Rp ${client.amount.toLocaleString('id-ID')}</small>
                    `;
                    
                    clientItem.addEventListener('click', () => {
                        selectedClientId = client.id;
                        renderClientList();
                        updateActionButtons();
                    });
                    
                    clientList.appendChild(clientItem);
                });
            }
            
            document.getElementById('client-count').textContent = `${clients.length} klien`;
        }

        // Fungsi untuk merender daftar portal
        function renderPortalList() {
            const portalList = document.getElementById('portal-list');
            portalList.innerHTML = '';
            
            if (portals.length === 0) {
                portalList.innerHTML = '<div class="list-group-item text-center text-muted">Tidak ada portal</div>';
            } else {
                portals.forEach(portal => {
                    const partnerShare = portal.amount * 0.2;
                    const netIncome = portal.amount - partnerShare;
                    
                    const portalItem = document.createElement('div');
                    portalItem.className = `list-group-item portal-item ${selectedPortalId === portal.id ? 'selected' : ''}`;
                    portalItem.setAttribute('data-portal-id', portal.id);
                    
                    portalItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${portal.name}</h5>
                            <span class="badge bg-primary">Rp ${portal.amount.toLocaleString('id-ID')}</span>
                        </div>
                        <p class="mb-1">${portal.location}</p>
                        <p class="mb-1">Partner: ${portal.partner}</p>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Bersih: <span class="portal-profit">Rp ${netIncome.toLocaleString('id-ID')}</span></small>
                            <small class="text-muted">Partner: <span class="portal-partner">Rp ${partnerShare.toLocaleString('id-ID')}</span></small>
                        </div>
                    `;
                    
                    portalItem.addEventListener('click', () => {
                        selectedPortalId = portal.id;
                        renderPortalList();
                        updatePortalDetails();
                    });
                    
                    portalList.appendChild(portalItem);
                });
            }
            
            document.getElementById('portal-total').textContent = `${portals.length} Portal`;
            updatePortalStatistics();
        }

        // Fungsi untuk memperbarui detail portal
        function updatePortalDetails() {
            const portalDetails = document.getElementById('portal-details');
            
            if (selectedPortalId === null) {
                portalDetails.innerHTML = '<p class="text-muted">Pilih portal untuk melihat detail perhitungan</p>';
                return;
            }
            
            const portal = portals.find(p => p.id === selectedPortalId);
            if (!portal) return;
            
            const partnerShare = portal.amount * 0.2;
            const netIncome = portal.amount - partnerShare;
            
            portalDetails.innerHTML = `
                <h5>${portal.name}</h5>
                <p><strong>Lokasi:</strong> ${portal.location}</p>
                <p><strong>Partner:</strong> ${portal.partner}</p>
                <hr>
                <h6>Perhitungan:</h6>
                <p>Total Isi Portal: <strong>Rp ${portal.amount.toLocaleString('id-ID')}</strong></p>
                <p>Bagian Partner (20%): <strong class="portal-partner">Rp ${partnerShare.toLocaleString('id-ID')}</strong></p>
                <p>Pendapatan Bersih: <strong class="portal-profit">Rp ${netIncome.toLocaleString('id-ID')}</strong></p>
            `;
        }

        // Fungsi untuk memperbarui statistik portal
        function updatePortalStatistics() {
            let totalAmount = 0;
            let totalNetIncome = 0;
            
            portals.forEach(portal => {
                totalAmount += portal.amount;
                totalNetIncome += portal.amount * 0.8; // 80% untuk kita
            });
            
            document.getElementById('portal-income').textContent = `Rp ${totalNetIncome.toLocaleString('id-ID')}`;
        }

        // Fungsi untuk mendapatkan teks status
        function getStatusText(status) {
            switch(status) {
                case 'paid': return 'Sudah Bayar';
                case 'invoiced': return 'Sudah Ditagih';
                case 'pending': return 'Belum Ditagih';
                case 'cancelled': return 'Dibatalkan';
                default: return 'Tidak Diketahui';
            }
        }

        // Fungsi untuk memperbarui statistik
        function updateStatistics() {
            const total = clients.length;
            const paid = clients.filter(c => c.status === 'paid').length;
            const invoiced = clients.filter(c => c.status === 'invoiced').length;
            const pending = clients.filter(c => c.status === 'pending').length;
            const cancelled = clients.filter(c => c.status === 'cancelled').length;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-paid').textContent = paid;
            document.getElementById('stat-invoiced').textContent = invoiced;
            document.getElementById('stat-pending').textContent = pending;
        }

        // Fungsi untuk memperbarui status tombol aksi
        function updateActionButtons() {
            const hasSelection = selectedClientId !== null;
            
            document.getElementById('btn-paid').disabled = !hasSelection;
            document.getElementById('btn-invoiced').disabled = !hasSelection;
            document.getElementById('btn-pending').disabled = !hasSelection;
            document.getElementById('btn-cancelled').disabled = !hasSelection;
        }

        // Fungsi untuk mengubah status klien
        function changeClientStatus(status) {
            if (selectedClientId === null) {
                alert('Pilih klien terlebih dahulu!');
                return;
            }
            
            const clientIndex = clients.findIndex(c => c.id === selectedClientId);
            if (clientIndex !== -1) {
                clients[clientIndex].status = status;
                saveData();
                renderClientList();
                updateStatistics();
                
                // Tampilkan notifikasi
                const clientName = clients[clientIndex].name;
                const statusText = getStatusText(status);
                alert(`Status ${clientName} berhasil diubah menjadi: ${statusText}`);
            }
        }

        // Fungsi untuk menghasilkan laporan klien
        function generateClientReport() {
            const reportTypes = {
                all: document.getElementById('report-all').checked,
                paid: document.getElementById('report-paid').checked,
                invoiced: document.getElementById('report-invoiced').checked,
                pending: document.getElementById('report-pending').checked,
                cancelled: document.getElementById('report-cancelled').checked
            };
            
            const actions = {
                telegram: document.getElementById('action-telegram').checked,
                downloadPaid: document.getElementById('action-download-paid').checked,
                downloadAll: document.getElementById('action-download-all').checked
            };
            
            // Filter klien berdasarkan jenis laporan yang dipilih
            let filteredClients = [];
            
            if (reportTypes.all) {
                filteredClients = clients;
            } else {
                if (reportTypes.paid) {
                    filteredClients = filteredClients.concat(clients.filter(c => c.status === 'paid'));
                }
                if (reportTypes.invoiced) {
                    filteredClients = filteredClients.concat(clients.filter(c => c.status === 'invoiced'));
                }
                if (reportTypes.pending) {
                    filteredClients = filteredClients.concat(clients.filter(c => c.status === 'pending'));
                }
                if (reportTypes.cancelled) {
                    filteredClients = filteredClients.concat(clients.filter(c => c.status === 'cancelled'));
                }
            }
            
            // Hitung total pendapatan
            let totalIncome = 0;
            filteredClients.forEach(client => {
                if (client.status === 'paid') {
                    totalIncome += client.amount;
                }
            });
            
            // Tampilkan hasil laporan
            let reportMessage = "LAPORAN PENAGIHAN KLIENT\n";
            reportMessage += "==========================\n\n";
            
            filteredClients.forEach(client => {
                reportMessage += `${client.name} | ${client.product} | Rp ${client.amount.toLocaleString('id-ID')} | ${getStatusText(client.status)}\n`;
            });
            
            reportMessage += `\nTOTAL PENDAPATAN: Rp ${totalIncome.toLocaleString('id-ID')}`;
            
            alert(reportMessage);
            
            // Simulasi aksi laporan
            if (actions.telegram) {
                alert("Mengirim laporan ke Telegram...");
            }
            
            if (actions.downloadPaid || actions.downloadAll) {
                exportToExcel(filteredClients, 'Laporan_Penagihan_Klient');
            }
        }

        // Fungsi untuk menghasilkan laporan portal
        function generatePortalReport() {
            const includeAll = document.getElementById('portal-report-all').checked;
            const downloadExcel = document.getElementById('portal-report-excel').checked;
            
            let reportPortals = includeAll ? portals : (selectedPortalId ? [portals.find(p => p.id === selectedPortalId)] : []);
            
            if (reportPortals.length === 0) {
                alert("Tidak ada portal yang dipilih untuk dilaporkan!");
                return;
            }
            
            // Hitung total
            let totalAmount = 0;
            let totalPartnerShare = 0;
            let totalNetIncome = 0;
            
            reportPortals.forEach(portal => {
                const partnerShare = portal.amount * 0.2;
                const netIncome = portal.amount - partnerShare;
                
                totalAmount += portal.amount;
                totalPartnerShare += partnerShare;
                totalNetIncome += netIncome;
            });
            
            // Tampilkan hasil laporan
            let reportMessage = "LAPORAN PORTAL\n";
            reportMessage += "==============\n\n";
            
            reportPortals.forEach(portal => {
                const partnerShare = portal.amount * 0.2;
                const netIncome = portal.amount - partnerShare;
                
                reportMessage += `${portal.name} | ${portal.location} | ${portal.partner}\n`;
                reportMessage += `  Total: Rp ${portal.amount.toLocaleString('id-ID')} | Partner: Rp ${partnerShare.toLocaleString('id-ID')} | Bersih: Rp ${netIncome.toLocaleString('id-ID')}\n\n`;
            });
            
            reportMessage += `TOTAL KESELURUHAN:\n`;
            reportMessage += `Total Isi Portal: Rp ${totalAmount.toLocaleString('id-ID')}\n`;
            reportMessage += `Total Untuk Partner: Rp ${totalPartnerShare.toLocaleString('id-ID')}\n`;
            reportMessage += `Total Pendapatan Bersih: Rp ${totalNetIncome.toLocaleString('id-ID')}`;
            
            alert(reportMessage);
            
            if (downloadExcel) {
                exportPortalsToExcel(reportPortals, 'Laporan_Portal');
            }
        }

        // Fungsi untuk ekspor data ke Excel
        function exportToExcel(data, filename) {
            // Siapkan data untuk Excel
            const worksheetData = [
                ['Nama Klien', 'Produk', 'Jumlah Tagihan', 'Status']
            ];
            
            let totalIncome = 0;
            
            data.forEach(client => {
                worksheetData.push([
                    client.name,
                    client.product,
                    client.amount,
                    getStatusText(client.status)
                ]);
                
                if (client.status === 'paid') {
                    totalIncome += client.amount;
                }
            });
            
            // Tambahkan baris total
            worksheetData.push([]);
            worksheetData.push(['TOTAL PENDAPATAN', '', totalIncome, '']);
            
            // Buat worksheet
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // Buat workbook dan tambahkan worksheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan Penagihan");
            
            // Ekspor ke file Excel
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Fungsi untuk ekspor data portal ke Excel
        function exportPortalsToExcel(data, filename) {
            // Siapkan data untuk Excel
            const worksheetData = [
                ['Nama Portal', 'Lokasi', 'Partner', 'Total Isi', 'Bagian Partner (20%)', 'Pendapatan Bersih']
            ];
            
            let totalAmount = 0;
            let totalPartnerShare = 0;
            let totalNetIncome = 0;
            
            data.forEach(portal => {
                const partnerShare = portal.amount * 0.2;
                const netIncome = portal.amount - partnerShare;
                
                worksheetData.push([
                    portal.name,
                    portal.location,
                    portal.partner,
                    portal.amount,
                    partnerShare,
                    netIncome
                ]);
                
                totalAmount += portal.amount;
                totalPartnerShare += partnerShare;
                totalNetIncome += netIncome;
            });
            
            // Tambahkan baris total
            worksheetData.push([]);
            worksheetData.push(['TOTAL', '', '', totalAmount, totalPartnerShare, totalNetIncome]);
            
            // Buat worksheet
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // Buat workbook dan tambahkan worksheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan Portal");
            
            // Ekspor ke file Excel
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Fungsi untuk reset data
        function resetData() {
            if (confirm("Apakah Anda yakin ingin menghapus semua data penagihan? Tindakan ini tidak dapat dibatalkan!")) {
                clients.forEach(client => {
                    if (client.status !== 'pending') {
                        client.status = 'pending';
                    }
                });
                
                saveData();
                renderClientList();
                updateStatistics();
                alert("Data penagihan berhasil direset. Klien yang belum bayar akan ditagih kembali bulan depan.");
            }
        }

        // Fungsi untuk backup data
        function backupData(type) {
            let data, filename;
            
            switch(type) {
                case 'clients':
                    data = clients;
                    filename = 'backup_klien_wifi_koin.json';
                    break;
                case 'portals':
                    data = portals;
                    filename = 'backup_portal_wifi_koin.json';
                    break;
                case 'all':
                    data = {
                        clients: clients,
                        portals: portals,
                        backupDate: new Date().toISOString()
                    };
                    filename = 'backup_lengkap_wifi_koin.json';
                    break;
            }
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename;
            link.click();
            
            alert(`Data ${type} berhasil diunduh!`);
        }

        // Fungsi untuk restore data
        function restoreData() {
            const fileInput = document.getElementById('restore-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file backup terlebih dahulu!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.clients && data.portals) {
                        // File backup lengkap
                        if (confirm('Data lengkap akan digantikan. Lanjutkan?')) {
                            clients = data.clients;
                            portals = data.portals;
                            saveData();
                            renderClientList();
                            renderPortalList();
                            updateStatistics();
                            alert('Data berhasil direstore!');
                        }
                    } else if (Array.isArray(data) && data.length > 0 && data[0].product) {
                        // File backup klien
                        if (confirm('Data klien akan digantikan. Lanjutkan?')) {
                            clients = data;
                            saveData();
                            renderClientList();
                            updateStatistics();
                            alert('Data klien berhasil direstore!');
                        }
                    } else if (Array.isArray(data) && data.length > 0 && data[0].location) {
                        // File backup portal
                        if (confirm('Data portal akan digantikan. Lanjutkan?')) {
                            portals = data;
                            saveData();
                            renderPortalList();
                            alert('Data portal berhasil direstore!');
                        }
                    } else {
                        alert('Format file backup tidak dikenali!');
                    }
                } catch (error) {
                    alert('Error membaca file backup: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // Inisialisasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            renderClientList();
            renderPortalList();
            updateStatistics();
            updateActionButtons();
            updatePortalDetails();
            
            // Event listener untuk tombol aksi klien
            document.getElementById('btn-paid').addEventListener('click', () => changeClientStatus('paid'));
            document.getElementById('btn-invoiced').addEventListener('click', () => changeClientStatus('invoiced'));
            document.getElementById('btn-pending').addEventListener('click', () => changeClientStatus('pending'));
            document.getElementById('btn-cancelled').addEventListener('click', () => changeClientStatus('cancelled'));
            
            // Event listener untuk generate laporan
            document.getElementById('generate-report').addEventListener('click', generateClientReport);
            document.getElementById('generate-portal-report').addEventListener('click', generatePortalReport);
            
            // Event listener untuk reset data
            document.getElementById('reset-data').addEventListener('click', resetData);
            
            // Event listener untuk checkbox "Semua Data"
            document.getElementById('report-all').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('#client input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    if (cb.id !== 'report-all') {
                        cb.checked = this.checked;
                    }
                });
            });
            
            // Event listener untuk tambah klien
            document.getElementById('save-client').addEventListener('click', function() {
                const name = document.getElementById('client-name').value;
                const product = document.getElementById('client-product').value;
                const amount = parseInt(document.getElementById('client-amount').value);
                
                if (name && product && amount) {
                    const newClient = {
                        id: clients.length > 0 ? Math.max(...clients.map(c => c.id)) + 1 : 1,
                        name: name,
                        product: product,
                        status: 'pending',
                        amount: amount
                    };
                    
                    clients.push(newClient);
                    saveData();
                    renderClientList();
                    updateStatistics();
                    
                    // Reset form dan tutup modal
                    document.getElementById('add-client-form').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addClientModal')).hide();
                    
                    alert('Klien berhasil ditambahkan!');
                } else {
                    alert('Harap isi semua field!');
                }
            });
            
            // Event listener untuk tambah portal
            document.getElementById('save-portal').addEventListener('click', function() {
                const name = document.getElementById('portal-name').value;
                const location = document.getElementById('portal-location').value;
                const amount = parseInt(document.getElementById('portal-amount').value);
                const partner = document.getElementById('portal-partner').value;
                
                if (name && location && amount && partner) {
                    const newPortal = {
                        id: portals.length > 0 ? Math.max(...portals.map(p => p.id)) + 1 : 1,
                        name: name,
                        location: location,
                        amount: amount,
                        partner: partner
                    };
                    
                    portals.push(newPortal);
                    saveData();
                    renderPortalList();
                    
                    // Reset form dan tutup modal
                    document.getElementById('add-portal-form').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addPortalModal')).hide();
                    
                    alert('Portal berhasil ditambahkan!');
                } else {
                    alert('Harap isi semua field!');
                }
            });
            
            // Event listener untuk backup data
            document.getElementById('backup-clients').addEventListener('click', () => backupData('clients'));
            document.getElementById('backup-portals').addEventListener('click', () => backupData('portals'));
            document.getElementById('backup-all').addEventListener('click', () => backupData('all'));
            
            // Event listener untuk restore data
            document.getElementById('restore-data').addEventListener('click', restoreData);
        });
    </script>
</body>
</html>
