<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="
    default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;
    connect-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;
    script-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;
    style-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;
  ">
  <title>WIFI KOIN AKHFI</title>
  <style>
    /* ===== VARIABEL CSS ===== */
    :root {
      --primary: #0044cc;
      --secondary: #007bff;
      --dark: #0056b3;
      --danger: #dc3545;
      --danger-dark: #c82333;
      --success: #28a745;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark-text: #212529;
      --border: #dee2e6;
    }

    /* ===== RESET & BASE STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #f5f8ff;
      color: var(--dark-text);
      font-size: 14px;
      line-height: 1.4;
    }

    /* ===== HEADER ===== */
    header {
      background: var(--primary);
      color: white;
      padding: 8px 10px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-wrap: wrap;
      gap: 10px;
    }
    
    header img {
      height: 50px;
      border-radius: 5px;
    }
    
    header h1 {
      font-size: 1.2rem;
      font-weight: bold;
    }

    /* ===== NAVIGASI ===== */
    nav {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      background: var(--secondary);
      gap: 1px;
    }
    
    nav button {
      padding: 10px 5px;
      border: none;
      background: var(--secondary);
      color: white;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    nav button:hover, nav button.active {
      background: var(--dark);
    }

    /* ===== SECTION ===== */
    section {
      display: none;
      padding: 12px;
    }
    
    section.active {
      display: block;
    }

    h2 {
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: var(--primary);
      text-align: center;
    }

    /* ===== FORM STYLES ===== */
    .form-group {
      margin-bottom: 10px;
    }
    
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
      font-size: 13px;
    }
    
    input, select {
      padding: 8px;
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
    }
    
    .form-note {
      font-size: 0.7rem;
      color: #666;
      margin-top: 2px;
    }

    /* ===== BUTTON STYLES ===== */
    .btn {
      background: var(--secondary);
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      margin: 5px 0;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.3s;
      width: 100%;
    }
    
    .btn:hover {
      background: var(--dark);
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-danger:hover {
      background: var(--danger-dark);
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--dark-text);
    }

    .btn-sm {
      padding: 5px 8px;
      font-size: 12px;
      margin: 2px;
    }

    /* ===== TABLE STYLES ===== */
    .table-container {
      overflow-x: auto;
      margin-top: 12px;
      -webkit-overflow-scrolling: touch;
      border: 1px solid var(--border);
      border-radius: 4px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 500px;
      font-size: 12px;
    }
    
    table, th, td {
      border: 1px solid var(--border);
    }
    
    th, td {
      padding: 6px;
      text-align: left;
    }
    
    th {
      background-color: var(--light);
      font-weight: bold;
      font-size: 11px;
    }
    
    /* Checkbox column */
    .checkbox-cell {
      width: 30px;
      text-align: center;
    }
    
    .checkbox-cell input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    /* ===== INVOICE PREVIEW ===== */
    #previewBox {
      background: #fff;
      border: 1px solid var(--border);
      padding: 10px;
      margin-top: 12px;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      line-height: 1.2;
      max-width: 280px;
      margin-left: auto;
      margin-right: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-x: auto;
    }
    
    .invoice-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 12px;
    }

    /* ===== VOUCHER SECTION STYLES ===== */
    .voucher-tabs {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .voucher-tab {
      padding: 8px 15px;
      cursor: pointer;
      border: none;
      background: var(--light);
      border-bottom: 2px solid transparent;
    }
    
    .voucher-tab.active {
      background: white;
      border-bottom: 2px solid var(--primary);
      font-weight: bold;
    }
    
    .voucher-subsection {
      display: none;
    }
    
    .voucher-subsection.active {
      display: block;
    }
    
    .voucher-preview {
      background: #f8f9fa;
      border: 1px solid var(--border);
      padding: 12px;
      margin-top: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    /* ===== LOADING STYLES ===== */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== SEARCH AND FILTER STYLES ===== */
    .search-box {
      margin-bottom: 15px;
      position: relative;
    }
    
    .search-box input {
      padding: 8px 35px 8px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      width: 100%;
    }
    
    .search-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
    }
    
    .filter-options {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .filter-options select, .filter-options input {
      flex: 1;
      min-width: 120px;
    }

    /* ===== EXPORT STYLES ===== */
    .export-options {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .export-options button {
      flex: 1;
      min-width: 120px;
    }

    /* ===== BACKUP STYLES ===== */
    .backup-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border: 1px solid var(--border);
    }
    
    .backup-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .backup-actions button {
      flex: 1;
      min-width: 120px;
    }

    /* ===== NOTIFICATION STYLES ===== */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 15px;
      border-radius: 4px;
      color: white;
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .notification.show {
      opacity: 1;
    }
    
    .notification.success {
      background: var(--success);
    }
    
    .notification.error {
      background: var(--danger);
    }

    .status-connected {
      color: var(--success);
      font-weight: bold;
    }

    .status-disconnected {
      color: var(--danger);
      font-weight: bold;
    }

    .profile-info {
      background: #e9ecef;
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 5px;
      font-size: 12px;
    }

    /* ===== DUE DATE STYLES ===== */
    .due-soon {
      background-color: #fff3cd !important;
      color: #856404;
    }
    
    .due-overdue {
      background-color: #f8d7da !important;
      color: #721c24;
    }

    /* ===== RESPONSIVE STYLES ===== */
    @media (min-width: 768px) {
      body {
        font-size: 15px;
      }
      
      header {
        padding: 12px 15px;
      }
      
      header img {
        height: 60px;
      }
      
      header h1 {
        font-size: 1.4rem;
      }
      
      nav {
        display: flex;
      }
      
      nav button {
        padding: 12px 8px;
        font-size: 14px;
        flex: 1;
      }
      
      section {
        padding: 15px;
        max-width: 1200px;
        margin: 0 auto;
      }
      
      h2 {
        font-size: 1.4rem;
      }
      
      .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }
      
      label {
        width: 150px;
        margin-bottom: 0;
        font-size: 14px;
      }
      
      input, select {
        width: calc(100% - 160px);
        max-width: 400px;
      }
      
      .form-note {
        margin-left: 150px;
      }
      
      .btn {
        width: auto;
        margin: 8px 5px 0 0;
        padding: 10px 15px;
        font-size: 14px;
      }
      
      .invoice-actions {
        flex-direction: row;
        justify-content: center;
      }
      
      th, td {
        padding: 8px;
        font-size: 13px;
      }
      
      th {
        font-size: 12px;
      }
      
      #previewBox {
        font-size: 11px;
        padding: 12px;
        max-width: 300px;
      }
      
      .voucher-tabs {
        margin-bottom: 20px;
      }
      
      .voucher-tab {
        padding: 10px 20px;
        font-size: 14px;
      }
      
      .search-box {
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <div id="notification" class="notification"></div>

  <header>
    <img src="gatotkaca.png" alt="Logo WIFI KOIN AKHFI" onerror="this.style.display='none'">
    <h1>WIFI KOIN AKHFI</h1>
  </header>

  <nav>
    <button onclick="showSection('clientTab')" class="active">Client</button>
    <button onclick="showSection('produkTab')">Produk</button>
    <button onclick="showSection('rekeningTab')">Pembayaran/DANA</button>
    <button onclick="showSection('invoiceTab')">Buat Invoice</button>
    <button onclick="showSection('voucherTab')">Kirim Voucher</button>
    <button onclick="showSection('backupTab')">Backup & Export</button>
  </nav>

  <!-- CLIENT -->
  <section id="clientTab" class="active">
    <h2>Manajemen Client</h2>
    
    <div class="search-box">
      <input type="text" id="searchClient" placeholder="Cari client..." onkeyup="filterClients()">
      <span class="search-icon">🔍</span>
    </div>
    
    <form id="clientForm">
      <input type="hidden" id="clientEditIndex" value="-1">
      <div class="form-group">
        <label for="clientName">Nama</label>
        <input type="text" id="clientName" required>
      </div>
      <div class="form-group">
        <label for="clientWhatsapp">WhatsApp</label>
        <input type="text" id="clientWhatsapp" required>
        <div class="form-note">Format: 628xxxxxxxxxx (contoh: 6281234567890)</div>
      </div>
      <div class="form-group">
        <label for="clientStartDate">Tanggal Mulai</label>
        <input type="date" id="clientStartDate">
      </div>
      <div class="form-group">
        <label for="clientDueDate">Tanggal Jatuh Tempo</label>
        <input type="date" id="clientDueDate">
      </div>
      <button type="button" class="btn" onclick="handleClientSubmit()">Tambah Client</button>
      <button type="button" id="cancelEditBtn" class="btn btn-danger" style="display:none;" onclick="cancelEditClient()">Batal Edit</button>
      <button type="button" class="btn btn-danger" onclick="deleteSelectedClients()">Hapus Terpilih</button>
    </form>
    
    <div class="export-options">
      <button class="btn btn-success" onclick="exportClientsToCSV()">Export ke CSV</button>
      <button class="btn btn-warning" onclick="checkDueDates()">Cek Jatuh Tempo</button>
    </div>
    
    <div class="table-container">
      <table id="clientTable">
        <thead>
          <tr>
            <th class="checkbox-cell">Pilih</th>
            <th>Nama</th>
            <th>WhatsApp</th>
            <th>Tanggal Mulai</th>
            <th>Jatuh Tempo</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- PRODUK -->
  <section id="produkTab">
    <h2>Manajemen Produk</h2>
    
    <div class="search-box">
      <input type="text" id="searchProduk" placeholder="Cari produk..." onkeyup="filterProduks()">
      <span class="search-icon">🔍</span>
    </div>
    
    <input type="hidden" id="produkEditIndex" value="-1">
    <div class="form-group">
      <label for="produkNama">Nama Produk</label>
      <input id="produkNama">
    </div>
    <div class="form-group">
      <label for="produkHarga">Harga</label>
      <input id="produkHarga" type="number">
    </div>
    <div class="form-group">
      <label for="produkDeskripsi">Deskripsi</label>
      <input id="produkDeskripsi">
    </div>
    <button class="btn" onclick="addProduk()">Tambah Produk</button>
    <button type="button" id="cancelEditProdukBtn" class="btn btn-danger" style="display:none;" onclick="cancelEditProduk()">Batal Edit</button>
    
    <div class="export-options">
      <button class="btn btn-success" onclick="exportProduksToCSV()">Export ke CSV</button>
    </div>
    
    <div class="table-container">
      <table id="produkTable">
        <thead>
          <tr>
            <th>Nama</th>
            <th>Harga</th>
            <th>Deskripsi</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- REKENING -->
  <section id="rekeningTab">
    <h2>Rekening & DANA</h2>
    
    <div class="search-box">
      <input type="text" id="searchRekening" placeholder="Cari rekening..." onkeyup="filterRekenings()">
      <span class="search-icon">🔍</span>
    </div>
    
    <form id="rekeningForm">
      <input type="hidden" id="rekeningEditIndex" value="-1">
      <div class="form-group">
        <label for="bank">Bank</label>
        <input type="text" id="bank" required>
      </div>
      <div class="form-group">
        <label for="noRekening">No Rekening</label>
        <input type="text" id="noRekening" required>
      </div>
      <div class="form-group">
        <label for="noDana">No DANA</label>
        <input type="text" id="noDana">
      </div>
      <button type="button" class="btn" onclick="simpanRekening()">Simpan Rekening</button>
      <button type="button" id="cancelEditRekeningBtn" class="btn btn-danger" style="display:none;" onclick="cancelEditRekening()">Batal Edit</button>
    </form>
    
    <div class="export-options">
      <button class="btn btn-success" onclick="exportRekeningsToCSV()">Export ke CSV</button>
    </div>
    
    <div class="table-container">
      <table id="rekeningTable">
        <thead>
          <tr>
            <th>Bank</th>
            <th>No Rekening</th>
            <th>No DANA</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- INVOICE -->
  <section id="invoiceTab">
    <h2>Buat Invoice</h2>
    <div class="form-group">
      <label for="noInvoice">Nomor Invoice</label>
      <input id="noInvoice" readonly>
    </div>
    <div class="form-group">
      <label for="tglInvoice">Tanggal</label>
      <input id="tglInvoice" readonly>
    </div>
    <div class="form-group">
      <label for="jatuhTempo">Jatuh Tempo</label>
      <input type="date" id="jatuhTempo">
    </div>
    <div class="form-group">
      <label for="pilihClient">Pilih Client</label>
      <select id="pilihClient"></select>
    </div>
    <div class="form-group">
      <label for="pilihProduk">Pilih Produk</label>
      <select id="pilihProduk"></select>
    </div>
    <div class="form-group">
      <label for="periode">Periode</label>
      <select id="periode">
        <option value="1">1 Bulan</option>
        <option value="2">2 Bulan</option>
        <option value="3">3 Bulan</option>
        <option value="6">6 Bulan</option>
        <option value="12">12 Bulan</option>
      </select>
    </div>
    
    <button class="btn" onclick="reviewInvoice()">REVIEW INVOICE</button>
    
    <div id="previewBox"></div>
    
    <div class="invoice-actions">
      <button id="btnWa" class="btn btn-success" style="display:none;" onclick="kirimWA()">Kirim ke WhatsApp</button>
      <button class="btn" onclick="kembaliKeMenu()">Kembali ke Menu Utama</button>
    </div>
  </section>

  <!-- VOUCHER -->
  <section id="voucherTab">
    <h2>Kirim Voucher</h2>
    
    <div class="voucher-tabs">
      <button class="voucher-tab active" onclick="showVoucherSubsection('voucherSetting')">Setting</button>
      <button class="voucher-tab" onclick="showVoucherSubsection('voucherKirim')">Kirim</button>
      <button class="voucher-tab" onclick="showVoucherSubsection('voucherHistory')">Riwayat</button>
    </div>
    
    <!-- Subsection Setting -->
    <div id="voucherSetting" class="voucher-subsection active">
      <h3>Setting Mikrotik</h3>
      
      <div class="form-group">
        <label for="mikrotikHost">Host/IP Mikrotik</label>
        <input type="text" id="mikrotikHost" placeholder="192.168.1.1" value="192.168.202.2">
      </div>
      <div class="form-group">
        <label for="mikrotikUser">Username</label>
        <input type="text" id="mikrotikUser" placeholder="admin" value="admin">
      </div>
      <div class="form-group">
        <label for="mikrotikPassword">Password</label>
        <input type="password" id="mikrotikPassword" placeholder="Password Mikrotik">
      </div>
      
      <button class="btn btn-success" onclick="saveMikrotikSettings()">Simpan Setting</button>
      <button class="btn btn-warning" onclick="testMikrotikConnection()">Test Koneksi</button>
      <div class="form-note">Setting disimpan di browser Anda</div>
    </div>
    
    <!-- Subsection Kirim -->
    <div id="voucherKirim" class="voucher-subsection">
      <h3>Kirim Voucher ke Client</h3>
      
      <div class="form-group">
        <label for="voucherClient">Pilih Client</label>
        <select id="voucherClient">
          <option value="">Pilih Client...</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="mikrotikProfile">Profile Hotspot</label>
        <select id="mikrotikProfile">
          <option value="PAKET-30D-1-USER">PAKET-30D-1-USER (30 Hari, 1 User)</option>
          <option value="PAKET-30D-2-USER-35RB">PAKET-30D-2-USER-35RB (30 Hari, 2 User)</option>
          <option value="PAKET-30D-3-USER-35RB">PAKET-30D-3-USER-35RB (30 Hari, 3 User)</option>
          <option value="PAKET-24-JAM">PAKET-24-JAM (24 Jam, 1 User)</option>
          <option value="PAKET-12-JAM">PAKET-12-JAM (12 Jam, 1 User)</option>
          <option value="PAKET-10-JAM">PAKET-10-JAM (10 Jam, 1 User)</option>
          <option value="PAKET-20-JAM">PAKET-20-JAM (20 Jam, 1 User)</option>
        </select>
      </div>
      
      <div id="profileInfo" class="profile-info">
        <strong>Info Profile:</strong>
        <div id="profileDetails">Pilih profile untuk melihat detail</div>
      </div>
      
      <div class="form-group">
        <label for="voucherPrice">Harga Voucher</label>
        <input type="number" id="voucherPrice" placeholder="100000" value="100000">
      </div>
      
      <div class="form-group">
        <label for="voucherComment">Keterangan (opsional)</label>
        <input type="text" id="voucherComment" placeholder="Keterangan voucher">
      </div>
      
      <button class="btn btn-success" onclick="generateVoucher()" id="generateVoucherBtn">
        Buat & Preview Voucher
      </button>
      
      <div id="voucherPreview" class="voucher-preview" style="display: none;"></div>
      
      <div class="invoice-actions" id="voucherActions" style="display: none;">
        <button class="btn btn-success" onclick="createAndSendVoucher()" id="createVoucherBtn">
          Simpan & Kirim ke WhatsApp
        </button>
        <button class="btn" onclick="kembaliKeMenu()">Kembali ke Menu Utama</button>
      </div>
    </div>
    
    <!-- Subsection Riwayat -->
    <div id="voucherHistory" class="voucher-subsection">
      <h3>Riwayat Voucher</h3>
      
      <div class="search-box">
        <input type="text" id="searchVoucher" placeholder="Cari voucher..." onkeyup="filterVouchers()">
        <span class="search-icon">🔍</span>
      </div>
      
      <div class="export-options">
        <button class="btn btn-success" onclick="exportVouchersToCSV()">Export ke CSV</button>
        <button class="btn btn-danger" onclick="clearVoucherHistory()">Hapus Riwayat</button>
      </div>
      
      <div class="table-container">
        <table id="voucherHistoryTable">
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Client</th>
              <th>Kode Voucher</th>
              <th>Profile</th>
              <th>Harga</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- BACKUP & EXPORT -->
  <section id="backupTab">
    <h2>Backup & Restore Data</h2>
    
    <div class="backup-section">
      <h3>Backup Data</h3>
      <p>Backup semua data aplikasi ke file JSON:</p>
      <div class="backup-actions">
        <button class="btn btn-success" onclick="backupAllData()">Backup Semua Data</button>
        <button class="btn btn-warning" onclick="exportAllToCSV()">Export Semua ke CSV</button>
      </div>
    </div>
    
    <div class="backup-section">
      <h3>Restore Data</h3>
      <p>Restore data dari file backup JSON:</p>
      <div class="form-group">
        <label for="backupFile">Pilih File Backup</label>
        <input type="file" id="backupFile" accept=".json">
      </div>
      <div class="backup-actions">
        <button class="btn btn-success" onclick="restoreData()">Restore Data</button>
        <button class="btn btn-danger" onclick="clearAllData()">Hapus Semua Data</button>
      </div>
    </div>
    
    <div class="backup-section">
      <h3>Notifikasi Jatuh Tempo</h3>
      <p>Atur notifikasi untuk client yang mendekati jatuh tempo:</p>
      <div class="form-group">
        <label for="notificationDays">Hari sebelum jatuh tempo</label>
        <input type="number" id="notificationDays" value="7" min="1" max="30">
      </div>
      <div class="backup-actions">
        <button class="btn btn-warning" onclick="checkDueDates()">Cek Sekarang</button>
        <button class="btn btn-success" onclick="saveNotificationSettings()">Simpan Setting</button>
      </div>
    </div>
  </section>

<script>
// ===== GLOBAL VARIABLES =====
let mikrotikSettings = JSON.parse(localStorage.getItem("mikrotikSettings")) || {};
let clients = JSON.parse(localStorage.getItem("clients")) || [];
let produks = JSON.parse(localStorage.getItem("produks")) || [];
let rekenings = JSON.parse(localStorage.getItem("rekening")) || [];
let vouchers = JSON.parse(localStorage.getItem("vouchers")) || [];
let invoiceText = "";
let voucherCode = "";
let currentVoucherData = null;
let notificationDays = parseInt(localStorage.getItem("notificationDays")) || 7;

// URL CLOUDFLARE WORKER - SESUAIKAN DENGAN URL ANDA
const CLOUDFLARE_WORKER_URL = 'https://wifi-koin-akhfi.muhammadrahmanarrasyid15.workers.dev';

// Profile mapping
const profileMappings = {
  'PAKET-30D-1-USER': { duration: 43200, sharedUsers: 1, type: '30 Hari', limit: '1 User' },
  'PAKET-30D-2-USER-35RB': { duration: 43200, sharedUsers: 2, type: '30 Hari', limit: '2 User' },
  'PAKET-30D-3-USER-35RB': { duration: 43200, sharedUsers: 3, type: '30 Hari', limit: '3 User' },
  'PAKET-24-JAM': { duration: 1440, sharedUsers: 1, type: '24 Jam', limit: '1 User' },
  'PAKET-12-JAM': { duration: 720, sharedUsers: 1, type: '12 Jam', limit: '1 User' },
  'PAKET-10-JAM': { duration: 600, sharedUsers: 1, type: '10 Jam', limit: '1 User' },
  'PAKET-20-JAM': { duration: 1200, sharedUsers: 1, type: '20 Jam', limit: '1 User' }
};

// ===== MIKROTIK API FUNCTIONS =====
async function testMikrotikConnection() {
  const host = document.getElementById('mikrotikHost').value;
  const user = document.getElementById('mikrotikUser').value;
  const password = document.getElementById('mikrotikPassword').value;
  
  if (!host || !user || !password) {
    showNotification('Host, user, dan password harus diisi!', 'error');
    return false;
  }
  
  showNotification('🔄 Menguji koneksi ke Mikrotik...', 'success');
  
  try {
    const response = await fetch(`${CLOUDFLARE_WORKER_URL}/test`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ host, user, password })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showNotification(`✅ Koneksi berhasil! Mikrotik ${result.data.platform} v${result.data.version}`, 'success');
      return true;
    } else {
      showNotification(`❌ Gagal: ${result.error}`, 'error');
      return false;
    }
  } catch (error) {
    showNotification(`❌ Error: ${error.message}`, 'error');
    return false;
  }
}

async function createMikrotikVoucher(voucherData) {
  const host = document.getElementById('mikrotikHost').value;
  const user = document.getElementById('mikrotikUser').value;
  const password = document.getElementById('mikrotikPassword').value;
  
  showNotification('🔄 Membuat voucher di Mikrotik...', 'success');
  
  try {
    const response = await fetch(`${CLOUDFLARE_WORKER_URL}/create-voucher`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        host,
        user,
        password,
        voucherCode: voucherData.voucherCode,
        profile: voucherData.profile,
        comment: voucherData.comment,
        limitUptime: voucherData.duration
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showNotification('✅ Voucher berhasil dibuat di Mikrotik!', 'success');
      return true;
    } else {
      showNotification(`❌ Gagal buat voucher: ${result.error}`, 'error');
      return false;
    }
  } catch (error) {
    showNotification(`❌ Error: ${error.message}`, 'error');
    return false;
  }
}

// ===== UTILITY FUNCTIONS =====
function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = `notification ${type} show`;
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

function saveData(key, data) {
  try {
    localStorage.setItem(key, JSON.stringify(data));
    return true;
  } catch (e) {
    console.warn('LocalStorage error:', e);
    return false;
  }
}

function loadData(key) {
  try {
    const data = localStorage.getItem(key);
    if (!data) return [];
    
    const parsed = JSON.parse(data);
    
    if (Array.isArray(parsed)) {
      return parsed;
    } else {
      console.warn(`Data ${key} bukan array, mengembalikan array kosong`);
      return [];
    }
  } catch (e) {
    console.warn(`Gagal memuat data ${key}:`, e);
    return [];
  }
}

// ===== NAVIGATION =====
function showSection(sectionId) {
  const sections = document.querySelectorAll('section');
  sections.forEach(section => {
    section.classList.remove('active');
  });
  
  const targetSection = document.getElementById(sectionId);
  if (targetSection) {
    targetSection.classList.add('active');
  }
  
  const buttons = document.querySelectorAll('nav button');
  buttons.forEach(button => {
    button.classList.remove('active');
  });
  
  const buttonIndex = Array.from(buttons).findIndex(btn => 
    btn.getAttribute('onclick')?.includes(sectionId)
  );
  if (buttonIndex !== -1) {
    buttons[buttonIndex].classList.add('active');
  }
  
  // Load data khusus untuk section tertentu
  if (sectionId === 'voucherTab') {
    loadVoucherHistory();
  }
}

function kembaliKeMenu() {
  showSection('clientTab');
}

// ===== CLIENT MANAGEMENT =====
function loadClients() {
  const tbody = document.querySelector("#clientTable tbody");
  if (!tbody) return;
  
  tbody.innerHTML = "";
  
  clients.forEach((c, i) => {
    const statusClass = getDueDateStatus(c.dueDate);
    const statusText = getDueDateText(c.dueDate);
    
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="checkbox-cell"><input type="checkbox" class="select-client" data-index="${i}"></td>
      <td>${c.name}</td>
      <td>${c.whatsapp}</td>
      <td>${c.startDate || ""}</td>
      <td class="${statusClass}">${c.dueDate || ""}</td>
      <td class="${statusClass}">${statusText}</td>
      <td>
        <button class="btn btn-sm" onclick="editClient(${i})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteClient(${i})">Hapus</button>
      </td>`;
    tbody.appendChild(tr);
  });
  
  refreshClientOptions();
  refreshVoucherClientOptions();
}

function getDueDateStatus(dueDate) {
  if (!dueDate) return '';
  
  const today = new Date();
  const due = new Date(dueDate);
  const diffTime = due - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) return 'due-overdue';
  if (diffDays <= notificationDays) return 'due-soon';
  return '';
}

function getDueDateText(dueDate) {
  if (!dueDate) return '-';
  
  const today = new Date();
  const due = new Date(dueDate);
  const diffTime = due - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) return `${Math.abs(diffDays)} hari lewat`;
  if (diffDays === 0) return 'Hari ini';
  if (diffDays === 1) return 'Besok';
  return `${diffDays} hari lagi`;
}

function handleClientSubmit() {
  const name = document.getElementById("clientName").value;
  const whatsapp = document.getElementById("clientWhatsapp").value;
  const startDate = document.getElementById("clientStartDate").value;
  const dueDate = document.getElementById("clientDueDate").value;
  const editIndex = parseInt(document.getElementById("clientEditIndex").value);
  
  if (!whatsapp.startsWith("628")) {
    alert("Format WhatsApp harus dimulai dengan 628 (contoh: 6281234567890)");
    return;
  }
  
  if (editIndex > -1) {
    clients[editIndex] = { name, whatsapp, startDate, dueDate };
    document.getElementById("clientEditIndex").value = "-1";
    document.getElementById("cancelEditBtn").style.display = "none";
  } else {
    clients.push({ name, whatsapp, startDate, dueDate });
  }
  
  saveData("clients", clients);
  loadClients();
  
  document.getElementById("clientName").value = "";
  document.getElementById("clientWhatsapp").value = "";
  document.getElementById("clientStartDate").value = "";
  document.getElementById("clientDueDate").value = "";
  
  showNotification("Data client berhasil disimpan!");
}

function deleteClient(index) {
  if (confirm("Apakah Anda yakin ingin menghapus client ini?")) {
    clients.splice(index, 1);
    saveData("clients", clients);
    loadClients();
    showNotification("Client berhasil dihapus");
  }
}

function editClient(index) {
  const c = clients[index];
  document.getElementById("clientName").value = c.name;
  document.getElementById("clientWhatsapp").value = c.whatsapp;
  document.getElementById("clientStartDate").value = c.startDate || "";
  document.getElementById("clientDueDate").value = c.dueDate || "";
  document.getElementById("clientEditIndex").value = index;
  document.getElementById("cancelEditBtn").style.display = "inline-block";
}

function cancelEditClient() {
  document.getElementById("clientName").value = "";
  document.getElementById("clientWhatsapp").value = "";
  document.getElementById("clientStartDate").value = "";
  document.getElementById("clientDueDate").value = "";
  document.getElementById("clientEditIndex").value = "-1";
  document.getElementById("cancelEditBtn").style.display = "none";
}

function deleteSelectedClients() {
  const checkboxes = document.querySelectorAll(".select-client:checked");
  
  if (checkboxes.length === 0) {
    alert("Pilih client yang akan dihapus terlebih dahulu");
    return;
  }
  
  if (confirm(`Apakah Anda yakin ingin menghapus ${checkboxes.length} client?`)) {
    const indexes = [...checkboxes].map(cb => parseInt(cb.dataset.index));
    indexes.sort((a, b) => b - a).forEach(i => clients.splice(i, 1));
    saveData("clients", clients);
    loadClients();
    showNotification(`${checkboxes.length} client berhasil dihapus`);
  }
}

function filterClients() {
  const searchTerm = document.getElementById('searchClient').value.toLowerCase();
  const rows = document.querySelectorAll('#clientTable tbody tr');
  
  rows.forEach(row => {
    const name = row.cells[1].textContent.toLowerCase();
    const whatsapp = row.cells[2].textContent.toLowerCase();
    
    if (name.includes(searchTerm) || whatsapp.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// ===== PRODUCT MANAGEMENT =====
function renderProduks() {
  const tbody = document.querySelector("#produkTable tbody");
  if (!tbody) return;
  
  tbody.innerHTML = "";
  
  produks.forEach((p, i) => {
    tbody.innerHTML += `<tr>
      <td>${p.nama}</td>
      <td>Rp ${p.harga.toLocaleString()}</td>
      <td>${p.deskripsi}</td>
      <td>
        <button class="btn btn-sm" onclick="editProduk(${i})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteProduk(${i})">Hapus</button>
      </td>
    </tr>`;
  });
  
  refreshProdukOptions();
}

function addProduk() {
  const nama = document.getElementById("produkNama").value;
  const harga = document.getElementById("produkHarga").value;
  const deskripsi = document.getElementById("produkDeskripsi").value;
  const editIndex = parseInt(document.getElementById("produkEditIndex").value);
  
  if (!nama || !harga) {
    alert("Nama & harga wajib diisi");
    return;
  }
  
  if (editIndex > -1) {
    produks[editIndex] = { nama, harga: parseInt(harga), deskripsi };
    document.getElementById("produkEditIndex").value = "-1";
    document.getElementById("cancelEditProdukBtn").style.display = "none";
  } else {
    produks.push({ nama, harga: parseInt(harga), deskripsi });
  }
  
  saveData("produks", produks);
  renderProduks();
  
  document.getElementById("produkNama").value = "";
  document.getElementById("produkHarga").value = "";
  document.getElementById("produkDeskripsi").value = "";
  
  showNotification("Produk berhasil disimpan!");
}

function editProduk(i) {
  const p = produks[i];
  document.getElementById("produkNama").value = p.nama;
  document.getElementById("produkHarga").value = p.harga;
  document.getElementById("produkDeskripsi").value = p.deskripsi;
  document.getElementById("produkEditIndex").value = i;
  document.getElementById("cancelEditProdukBtn").style.display = "inline-block";
}

function cancelEditProduk() {
  document.getElementById("produkNama").value = "";
  document.getElementById("produkHarga").value = "";
  document.getElementById("produkDeskripsi").value = "";
  document.getElementById("produkEditIndex").value = "-1";
  document.getElementById("cancelEditProdukBtn").style.display = "none";
}

function deleteProduk(i) {
  if (confirm("Apakah Anda yakin ingin menghapus produk ini?")) {
    produks.splice(i, 1);
    saveData("produks", produks);
    renderProduks();
    showNotification("Produk berhasil dihapus");
  }
}

function filterProduks() {
  const searchTerm = document.getElementById('searchProduk').value.toLowerCase();
  const rows = document.querySelectorAll('#produkTable tbody tr');
  
  rows.forEach(row => {
    const name = row.cells[0].textContent.toLowerCase();
    const desc = row.cells[2].textContent.toLowerCase();
    
    if (name.includes(searchTerm) || desc.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// ===== REKENING MANAGEMENT =====
function loadRekening() {
  const tbody = document.querySelector("#rekeningTable tbody");
  if (!tbody) return;
  
  tbody.innerHTML = "";
  
  if (!Array.isArray(rekenings)) {
    rekenings = [];
    saveData("rekening", rekenings);
  }
  
  rekenings.forEach((r, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.bank}</td>
      <td>${r.noRekening}</td>
      <td>${r.noDana || ""}</td>
      <td>
        <button class="btn btn-sm" onclick="editRekening(${i})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteRekening(${i})">Hapus</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function simpanRekening() {
  const bank = document.getElementById("bank").value;
  const noRekening = document.getElementById("noRekening").value;
  const noDana = document.getElementById("noDana").value;
  const editIndex = parseInt(document.getElementById("rekeningEditIndex").value);

  if (!bank || !noRekening) {
    alert("Bank dan No Rekening wajib diisi");
    return;
  }

  if (!Array.isArray(rekenings)) {
    rekenings = [];
  }

  if (editIndex > -1) {
    rekenings[editIndex] = { bank, noRekening, noDana };
    document.getElementById("rekeningEditIndex").value = "-1";
    document.getElementById("cancelEditRekeningBtn").style.display = "none";
  } else {
    rekenings.push({ bank, noRekening, noDana });
  }
  
  saveData("rekening", rekenings);
  document.getElementById("rekeningForm").reset();
  loadRekening();
  
  showNotification("Data rekening berhasil disimpan!");
}

function deleteRekening(index) {
  if (confirm("Apakah Anda yakin ingin menghapus rekening ini?")) {
    if (!Array.isArray(rekenings)) {
      rekenings = [];
    }
    
    rekenings.splice(index, 1);
    saveData("rekening", rekenings);
    loadRekening();
    showNotification("Rekening berhasil dihapus");
  }
}

function editRekening(index) {
  if (!Array.isArray(rekenings)) {
    rekenings = [];
    return;
  }
  
  const r = rekenings[index];
  document.getElementById("bank").value = r.bank;
  document.getElementById("noRekening").value = r.noRekening;
  document.getElementById("noDana").value = r.noDana || "";
  document.getElementById("rekeningEditIndex").value = index;
  document.getElementById("cancelEditRekeningBtn").style.display = "inline-block";
}

function cancelEditRekening() {
  document.getElementById("rekeningForm").reset();
  document.getElementById("rekeningEditIndex").value = "-1";
  document.getElementById("cancelEditRekeningBtn").style.display = "none";
}

function filterRekenings() {
  const searchTerm = document.getElementById('searchRekening').value.toLowerCase();
  const rows = document.querySelectorAll('#rekeningTable tbody tr');
  
  rows.forEach(row => {
    const bank = row.cells[0].textContent.toLowerCase();
    const noRek = row.cells[1].textContent.toLowerCase();
    
    if (bank.includes(searchTerm) || noRek.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// ===== INVOICE SYSTEM =====
function refreshClientOptions() {
  const sel = document.getElementById("pilihClient");
  if (!sel) return;
  
  sel.innerHTML = "";
  
  clients.forEach((c, i) => {
    sel.innerHTML += `<option value="${i}">${c.name}</option>`;
  });
}

function refreshProdukOptions() {
  const sel = document.getElementById("pilihProduk");
  if (!sel) return;
  
  sel.innerHTML = "";
  
  produks.forEach((p, i) => {
    sel.innerHTML += `<option value="${i}">${p.nama} - Rp ${p.harga.toLocaleString()}</option>`;
  });
}

function generateInvoiceNo() {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  
  let num = localStorage.getItem("lastInvoice") || 0;
  num = parseInt(num) + 1;
  localStorage.setItem("lastInvoice", num);
  
  return `INV/${year}${month}/${String(num).padStart(4, '0')}`;
}

function reviewInvoice() {
  const no = document.getElementById("noInvoice").value;
  const tgl = new Date(document.getElementById("tglInvoice").value).toLocaleDateString("id-ID");
  const tempo = new Date(document.getElementById("jatuhTempo").value).toLocaleDateString("id-ID");
  
  const clientIndex = parseInt(document.getElementById("pilihClient").value);
  const client = clients[clientIndex];
  
  if (!client) {
    alert("Pilih client terlebih dahulu");
    return;
  }
  
  const produkIndex = parseInt(document.getElementById("pilihProduk").value);
  const produk = produks[produkIndex];
  
  if (!produk) {
    alert("Pilih produk terlebih dahulu");
    return;
  }
  
  const periode = parseInt(document.getElementById("periode").value);
  const total = produk.harga * periode;
  
  const rek = rekenings.length ? rekenings[0] : { bank: "-", noRekening: "-", noDana: "-" };

  invoiceText = `WIFI KOIN AKHFI
================
INV: ${no}
TGL: ${tgl}
JTH: ${tempo}
----------------
CLIENT: ${client.name}
WA: ${client.whatsapp}
----------------
LAYANAN: ${produk.nama}
PERIODE: ${periode} Bln
HARGA: Rp${produk.harga.toLocaleString()}/bln
----------------
TOTAL: Rp${total.toLocaleString()}
================
BAYAR KE:
${rek.bank}: ${rek.noRekening}
DANA: ${rek.noDana || '-'}
================
HUBUNGI:
WA: 085934241038
TERIMA KASIH
================`;

  document.getElementById("previewBox").textContent = invoiceText;
  document.getElementById("btnWa").style.display = "inline-block";
}

function kirimWA() {
  const clientIndex = parseInt(document.getElementById("pilihClient").value);
  const client = clients[clientIndex];
  
  if (!client || !client.whatsapp) {
    alert("Nomor WhatsApp client belum diisi.");
    return;
  }
  
  const pesan = document.getElementById("previewBox").innerText;
  const noWa = client.whatsapp.replace(/\D/g, "");
  const url = "https://wa.me/" + noWa + "?text=" + encodeURIComponent(pesan);
  window.open(url, "_blank");
  
  setTimeout(() => {
    showSection('clientTab');
  }, 2000);
}

// ===== VOUCHER SYSTEM =====
function showVoucherSubsection(subsectionId) {
  const subsections = document.querySelectorAll('.voucher-subsection');
  subsections.forEach(subsection => {
    subsection.classList.remove('active');
  });
  
  document.getElementById(subsectionId).classList.add('active');
  
  const tabs = document.querySelectorAll('.voucher-tab');
  tabs.forEach(tab => {
    tab.classList.remove('active');
  });
  
  const activeTab = Array.from(tabs).find(tab => 
    tab.getAttribute('onclick')?.includes(subsectionId)
  );
  if (activeTab) {
    activeTab.classList.add('active');
  }
  
  if (subsectionId === 'voucherHistory') {
    loadVoucherHistory();
  }
}

function refreshVoucherClientOptions() {
  const sel = document.getElementById("voucherClient");
  if (!sel) return;
  
  sel.innerHTML = '<option value="">Pilih Client...</option>';
  
  clients.forEach((c, i) => {
    sel.innerHTML += `<option value="${i}">${c.name} - ${c.whatsapp}</option>`;
  });
}

function saveMikrotikSettings() {
  const host = document.getElementById('mikrotikHost').value;
  const user = document.getElementById('mikrotikUser').value;
  const password = document.getElementById('mikrotikPassword').value;
  
  mikrotikSettings = {
    host,
    user,
    password
  };
  
  localStorage.setItem("mikrotikSettings", JSON.stringify(mikrotikSettings));
  showNotification("Setting Mikrotik berhasil disimpan!");
}

function updateProfileInfo() {
  const profileSelect = document.getElementById('mikrotikProfile');
  const profileDetails = document.getElementById('profileDetails');
  
  const selectedProfile = profileSelect.value;
  
  if (selectedProfile && profileMappings[selectedProfile]) {
    const profile = profileMappings[selectedProfile];
    profileDetails.innerHTML = `
      Jenis: ${profile.type}<br>
      Durasi: ${profile.duration} menit<br>
      Limit Penggunaan: ${profile.limit}<br>
      Shared Users: ${profile.sharedUsers}
    `;
  } else {
    profileDetails.innerHTML = 'Pilih profile untuk melihat detail';
  }
}

async function generateVoucher() {
  const clientIndex = parseInt(document.getElementById("voucherClient").value);
  const client = clients[clientIndex];
  const profile = document.getElementById('mikrotikProfile').value;
  
  if (!client) {
    alert("Pilih client terlebih dahulu");
    return;
  }
  
  if (!profile) {
    alert("Pilih profile hotspot terlebih dahulu");
    return;
  }
  
  // Test koneksi dulu
  const isConnected = await testMikrotikConnection();
  if (!isConnected) {
    return;
  }
  
  const voucherPrice = document.getElementById("voucherPrice").value;
  const voucherComment = document.getElementById("voucherComment").value;
  
  // Generate kode voucher
  voucherCode = client.name.replace(/\s+/g, '').toLowerCase();
  if (voucherCode.length < 4) {
    voucherCode += Math.floor(1000 + Math.random() * 9000);
  }
  
  const profileInfo = profileMappings[profile];
  
  let durationText = "";
  let durationValue = "";
  
  if (profileInfo.duration < 60) {
    durationText = `${profileInfo.duration} menit`;
    durationValue = `${profileInfo.duration}m`;
  } else if (profileInfo.duration < 1440) {
    const hours = Math.floor(profileInfo.duration / 60);
    durationText = `${hours} jam`;
    durationValue = `${hours}h`;
  } else {
    const days = Math.floor(profileInfo.duration / 1440);
    durationText = `${days} hari`;
    durationValue = `${days}d`;
  }
  
  const voucherPreview = document.getElementById("voucherPreview");
  const priceText = voucherPrice > 0 ? `Harga: Rp ${parseInt(voucherPrice).toLocaleString()}` : "GRATIS";
  
  voucherPreview.innerHTML = `VOUCHER WIFI KOIN AKHFI
========================
Username: ${voucherCode}
Password: ${voucherCode}
Profile: ${profile}
Durasi: ${durationText}
${priceText}
Limit: ${profileInfo.limit}
${voucherComment ? `Keterangan: ${voucherComment}` : ''}
========================
Cara pakai:
1. Hubungkan ke WiFi Koin Akhfi
2. Buka browser
3. Masukkan Kode Voucher
4. Nikmati internet
========================
Terima kasih!`;
  
  voucherPreview.style.display = 'block';
  document.getElementById("voucherActions").style.display = 'flex';
  
  // Simpan data voucher untuk digunakan nanti
  currentVoucherData = {
    voucherCode,
    profile,
    duration: durationValue,
    price: voucherPrice,
    comment: voucherComment
  };
}

async function createAndSendVoucher() {
  if (!currentVoucherData) {
    alert("Generate voucher terlebih dahulu!");
    return;
  }
  
  const clientIndex = parseInt(document.getElementById("voucherClient").value);
  const client = clients[clientIndex];
  
  // Buat voucher di Mikrotik
  const voucherCreated = await createMikrotikVoucher(currentVoucherData);
  
  if (!voucherCreated) {
    return;
  }
  
  // Simpan ke localStorage
  const newVoucher = {
    code: currentVoucherData.voucherCode,
    client: client.name,
    whatsapp: client.whatsapp,
    date: new Date().toISOString(),
    profile: currentVoucherData.profile,
    price: currentVoucherData.price || 0,
    comment: currentVoucherData.comment || ''
  };
  
  vouchers.push(newVoucher);
  saveData("vouchers", vouchers);
  
  // Kirim ke WhatsApp
  const voucherMessage = document.getElementById("voucherPreview").innerText;
  const noWa = client.whatsapp.replace(/\D/g, "");
  const url = "https://wa.me/" + noWa + "?text=" + encodeURIComponent(voucherMessage);
  window.open(url, "_blank");
  
  showNotification("✅ Voucher berhasil dibuat dan dikirim ke WhatsApp!");
  
  setTimeout(() => {
    showSection('clientTab');
  }, 3000);
}

function loadVoucherHistory() {
  const tbody = document.querySelector("#voucherHistoryTable tbody");
  if (!tbody) return;
  
  tbody.innerHTML = "";
  
  if (!Array.isArray(vouchers)) {
    vouchers = [];
    saveData("vouchers", vouchers);
  }
  
  vouchers.forEach((v, i) => {
    const date = new Date(v.date).toLocaleDateString("id-ID");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${date}</td>
      <td>${v.client}</td>
      <td>${v.code}</td>
      <td>${v.profile}</td>
      <td>${v.price > 0 ? 'Rp ' + parseInt(v.price).toLocaleString() : 'GRATIS'}</td>
      <td>
        <button class="btn btn-sm" onclick="resendVoucher(${i})">Kirim Ulang</button>
        <button class="btn btn-sm btn-danger" onclick="deleteVoucher(${i})">Hapus</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function filterVouchers() {
  const searchTerm = document.getElementById('searchVoucher').value.toLowerCase();
  const rows = document.querySelectorAll('#voucherHistoryTable tbody tr');
  
  rows.forEach(row => {
    const client = row.cells[1].textContent.toLowerCase();
    const code = row.cells[2].textContent.toLowerCase();
    const profile = row.cells[3].textContent.toLowerCase();
    
    if (client.includes(searchTerm) || code.includes(searchTerm) || profile.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

function resendVoucher(index) {
  const v = vouchers[index];
  const voucherMessage = `VOUCHER WIFI KOIN AKHFI
========================
Username: ${v.code}
Password: ${v.code}
Profile: ${v.profile}
${v.price > 0 ? `Harga: Rp ${parseInt(v.price).toLocaleString()}` : "GRATIS"}
${v.comment ? `Keterangan: ${v.comment}` : ''}
========================
Cara pakai:
1. Hubungkan ke WiFi Koin Akhfi
2. Buka browser
3. Masukkan Kode Voucher
4. Nikmati internet
========================
Terima kasih!`;
  
  const noWa = v.whatsapp.replace(/\D/g, "");
  const url = "https://wa.me/" + noWa + "?text=" + encodeURIComponent(voucherMessage);
  window.open(url, "_blank");
  
  showNotification("Voucher dikirim ulang ke WhatsApp!");
}

function deleteVoucher(index) {
  if (confirm("Apakah Anda yakin ingin menghapus voucher ini dari riwayat?")) {
    if (!Array.isArray(vouchers)) {
      vouchers = [];
    }
    
    vouchers.splice(index, 1);
    saveData("vouchers", vouchers);
    loadVoucherHistory();
    showNotification("Voucher berhasil dihapus dari riwayat");
  }
}

function clearVoucherHistory() {
  if (confirm("Apakah Anda yakin ingin menghapus semua riwayat voucher?")) {
    vouchers = [];
    saveData("vouchers", vouchers);
    loadVoucherHistory();
    showNotification("Semua riwayat voucher berhasil dihapus");
  }
}

// ===== EXPORT FUNCTIONS =====
function exportClientsToCSV() {
  if (clients.length === 0) {
    showNotification("Tidak ada data client untuk diexport", "error");
    return;
  }
  
  let csv = "Nama,WhatsApp,Tanggal Mulai,Jatuh Tempo\n";
  
  clients.forEach(client => {
    csv += `"${client.name}","${client.whatsapp}","${client.startDate || ''}","${client.dueDate || ''}"\n`;
  });
  
  downloadCSV(csv, "clients.csv");
  showNotification("Data client berhasil diexport ke CSV");
}

function exportProduksToCSV() {
  if (produks.length === 0) {
    showNotification("Tidak ada data produk untuk diexport", "error");
    return;
  }
  
  let csv = "Nama,Harga,Deskripsi\n";
  
  produks.forEach(produk => {
    csv += `"${produk.nama}","${produk.harga}","${produk.deskripsi}"\n`;
  });
  
  downloadCSV(csv, "produks.csv");
  showNotification("Data produk berhasil diexport ke CSV");
}

function exportRekeningsToCSV() {
  if (rekenings.length === 0) {
    showNotification("Tidak ada data rekening untuk diexport", "error");
    return;
  }
  
  let csv = "Bank,No Rekening,No DANA\n";
  
  rekenings.forEach(rekening => {
    csv += `"${rekening.bank}","${rekening.noRekening}","${rekening.noDana || ''}"\n`;
  });
  
  downloadCSV(csv, "rekenings.csv");
  showNotification("Data rekening berhasil diexport ke CSV");
}

function exportVouchersToCSV() {
  if (vouchers.length === 0) {
    showNotification("Tidak ada data voucher untuk diexport", "error");
    return;
  }
  
  let csv = "Tanggal,Client,Kode Voucher,Profile,Harga,Keterangan\n";
  
  vouchers.forEach(voucher => {
    const date = new Date(voucher.date).toLocaleDateString("id-ID");
    csv += `"${date}","${voucher.client}","${voucher.code}","${voucher.profile}","${voucher.price}","${voucher.comment || ''}"\n`;
  });
  
  downloadCSV(csv, "vouchers.csv");
  showNotification("Data voucher berhasil diexport ke CSV");
}

function exportAllToCSV() {
  if (clients.length === 0 && produks.length === 0 && rekenings.length === 0 && vouchers.length === 0) {
    showNotification("Tidak ada data untuk diexport", "error");
    return;
  }
  
  let zip = new JSZip();
  
  if (clients.length > 0) {
    let csv = "Nama,WhatsApp,Tanggal Mulai,Jatuh Tempo\n";
    clients.forEach(client => {
      csv += `"${client.name}","${client.whatsapp}","${client.startDate || ''}","${client.dueDate || ''}"\n`;
    });
    zip.file("clients.csv", csv);
  }
  
  if (produks.length > 0) {
    let csv = "Nama,Harga,Deskripsi\n";
    produks.forEach(produk => {
      csv += `"${produk.nama}","${produk.harga}","${produk.deskripsi}"\n`;
    });
    zip.file("produks.csv", csv);
  }
  
  if (rekenings.length > 0) {
    let csv = "Bank,No Rekening,No DANA\n";
    rekenings.forEach(rekening => {
      csv += `"${rekening.bank}","${rekening.noRekening}","${rekening.noDana || ''}"\n`;
    });
    zip.file("rekenings.csv", csv);
  }
  
  if (vouchers.length > 0) {
    let csv = "Tanggal,Client,Kode Voucher,Profile,Harga,Keterangan\n";
    vouchers.forEach(voucher => {
      const date = new Date(voucher.date).toLocaleDateString("id-ID");
      csv += `"${date}","${voucher.client}","${voucher.code}","${voucher.profile}","${voucher.price}","${voucher.comment || ''}"\n`;
    });
    zip.file("vouchers.csv", csv);
  }
  
  zip.generateAsync({type:"blob"}).then(function(content) {
    const url = URL.createObjectURL(content);
    const a = document.createElement("a");
    a.href = url;
    a.download = "wifi_koin_akhfi_backup.zip";
    a.click();
    URL.revokeObjectURL(url);
  });
  
  showNotification("Semua data berhasil diexport");
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// ===== BACKUP & RESTORE FUNCTIONS =====
function backupAllData() {
  const backupData = {
    clients: clients,
    produks: produks,
    rekenings: rekenings,
    vouchers: vouchers,
    mikrotikSettings: mikrotikSettings,
    backupDate: new Date().toISOString()
  };
  
  const dataStr = JSON.stringify(backupData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  
  const url = URL.createObjectURL(dataBlob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `wifi_koin_akhfi_backup_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification("Backup semua data berhasil!");
}

function restoreData() {
  const fileInput = document.getElementById('backupFile');
  const file = fileInput.files[0];
  
  if (!file) {
    showNotification("Pilih file backup terlebih dahulu", "error");
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backupData = JSON.parse(e.target.result);
      
      if (confirm("Apakah Anda yakin ingin restore data? Data saat ini akan diganti.")) {
        if (backupData.clients) clients = backupData.clients;
        if (backupData.produks) produks = backupData.produks;
        if (backupData.rekenings) rekenings = backupData.rekenings;
        if (backupData.vouchers) vouchers = backupData.vouchers;
        if (backupData.mikrotikSettings) mikrotikSettings = backupData.mikrotikSettings;
        
        saveData("clients", clients);
        saveData("produks", produks);
        saveData("rekening", rekenings);
        saveData("vouchers", vouchers);
        localStorage.setItem("mikrotikSettings", JSON.stringify(mikrotikSettings));
        
        // Reload semua data
        loadClients();
        renderProduks();
        loadRekening();
        loadVoucherHistory();
        
        // Load Mikrotik settings
        if (mikrotikSettings.host) {
          document.getElementById('mikrotikHost').value = mikrotikSettings.host;
          document.getElementById('mikrotikUser').value = mikrotikSettings.user;
          document.getElementById('mikrotikPassword').value = mikrotikSettings.password;
        }
        
        showNotification("Data berhasil direstore!");
        fileInput.value = "";
      }
    } catch (error) {
      showNotification("Error: File backup tidak valid", "error");
      console.error(error);
    }
  };
  reader.readAsText(file);
}

function clearAllData() {
  if (confirm("Apakah Anda yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!")) {
    clients = [];
    produks = [];
    rekenings = [];
    vouchers = [];
    
    saveData("clients", clients);
    saveData("produks", produks);
    saveData("rekening", rekenings);
    saveData("vouchers", vouchers);
    
    loadClients();
    renderProduks();
    loadRekening();
    loadVoucherHistory();
    
    showNotification("Semua data berhasil dihapus");
  }
}

// ===== NOTIFICATION FUNCTIONS =====
function checkDueDates() {
  const today = new Date();
  let dueSoonCount = 0;
  let overdueCount = 0;
  
  clients.forEach(client => {
    if (client.dueDate) {
      const due = new Date(client.dueDate);
      const diffTime = due - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays < 0) {
        overdueCount++;
      } else if (diffDays <= notificationDays) {
        dueSoonCount++;
      }
    }
  });
  
  let message = "";
  if (overdueCount > 0) {
    message += `${overdueCount} client sudah lewat jatuh tempo. `;
  }
  if (dueSoonCount > 0) {
    message += `${dueSoonCount} client mendekati jatuh tempo (${notificationDays} hari).`;
  }
  
  if (message) {
    showNotification(message, overdueCount > 0 ? "error" : "success");
  } else {
    showNotification("Tidak ada client yang mendekati jatuh tempo", "success");
  }
}

function saveNotificationSettings() {
  const days = parseInt(document.getElementById('notificationDays').value);
  if (days >= 1 && days <= 30) {
    notificationDays = days;
    localStorage.setItem("notificationDays", days.toString());
    showNotification("Setting notifikasi berhasil disimpan!");
  } else {
    showNotification("Masukkan angka antara 1-30", "error");
  }
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('Aplikasi dimuat');
  
  // Load data
  clients = loadData("clients");
  produks = loadData("produks");
  rekenings = loadData("rekening");
  vouchers = loadData("vouchers");
  
  // Initialize components
  loadClients();
  renderProduks();
  loadRekening();
  refreshClientOptions();
  refreshProdukOptions();
  refreshVoucherClientOptions();
  
  // Set invoice defaults
  document.getElementById("noInvoice").value = generateInvoiceNo();
  document.getElementById("tglInvoice").value = new Date().toISOString().split('T')[0];
  
  const nextWeek = new Date();
  nextWeek.setDate(nextWeek.getDate() + 7);
  document.getElementById("jatuhTempo").value = nextWeek.toISOString().split('T')[0];
  
  // Load Mikrotik settings
  if (mikrotikSettings.host) {
    document.getElementById('mikrotikHost').value = mikrotikSettings.host;
    document.getElementById('mikrotikUser').value = mikrotikSettings.user;
    document.getElementById('mikrotikPassword').value = mikrotikSettings.password;
  }
  
  // Load notification settings
  document.getElementById('notificationDays').value = notificationDays;
  
  // Event listener untuk profile
  document.getElementById('mikrotikProfile').addEventListener('change', updateProfileInfo);
  
  // Initialize profile info
  updateProfileInfo();
  
  console.log('Aplikasi siap digunakan');
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>
